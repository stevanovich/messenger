# Где хранятся настройки и данные звонков, как проверить

## 1. Настройки звонков (конфиг приложения)

**Файл:** `config/config.php`

Здесь задаются **глобальные** параметры звонков (не per-user):

| Константа | Назначение |
|-----------|------------|
| `SIP_WS_URL` | URL SIP WebSocket (пусто = только WebRTC) |
| `SIP_DOMAIN` | Домен SIP |
| `SIP_STUN_URL` | STUN-сервер (по умолчанию Google) |
| `SIP_TURN_URL`, `SIP_TURN_USER`, `SIP_TURN_CREDENTIAL` | TURN (опционально) |
| `WEBSOCKET_*` | Порт/URL WebSocket для событий чата и звонков |

**Как проверить:** откройте `config/config.php` и посмотрите блок «Звонки (SIP / WebRTC)» и блок WebSocket. Значения можно переопределить переменными окружения (getenv).

---

## 2. Данные звонков в базе данных

Сохраняется **состояние звонков и участники**, а не «настройки» в смысле предпочтений пользователя.

**Таблицы (см. `sql/schema.sql` и миграции в `sql/migrations/`, `tools/run_*_migration.php`):**

| Таблица | Что хранит |
|---------|------------|
| `call_logs` | История 1-на-1 звонков: кто, кому, когда, длительность, с видео или нет |
| `group_calls` | Групповые звонки: беседа, создатель, с видео, время начала/конца |
| `group_call_participants` | Участники группового звонка (кто зашёл/вышел) |
| `group_call_guests` | Гости по ссылке (имя, токен, время входа/выхода) |
| `call_links` | Ссылки «присоединиться к звонку» (токен, срок действия) |
| `user_sip_credentials` | SIP-пароли пользователей (если включён SIP) |
| `ws_guest_tokens` | Временные токены для WebSocket гостей звонка |

**Как проверить в БД:**

```sql
-- Активные звонки 1-на-1 (без ended_at)
SELECT * FROM call_logs WHERE ended_at IS NULL;

-- Активные групповые звонки
SELECT * FROM group_calls WHERE ended_at IS NULL;

-- Действующие ссылки на присоединение
SELECT * FROM call_links WHERE expires_at > NOW();
```

Подключение к БД задаётся в `config/database.php` (или через переменные окружения).

---

## 3. Что отдаётся клиенту при «настройках звонков»

**API:** `GET /api/calls.php?action=config`

В `api/calls.php` (case `'config'`) формируется объект из констант конфига: `call_mode`, `sip_uri`, `stun`, `turn`, `user_uuid` и т.д. Пароль TURN в ответ не попадает (только метка `'***'`). Отдельных «настроек звонков пользователя» в API нет — только общий конфиг и состояние звонков (статус, участники, ссылки).

**Как проверить:** в браузере или через curl:

```bash
curl -b "PHPSESSID=ваша_сессия" "https://ваш-домен/api/calls.php?action=config"
```

---

## 4. Итог

- **Настройки звонков** (режим SIP/WebRTC, STUN/TURN, домен) хранятся только в **`config/config.php`** (и опционально в env).
- **Информация о звонках** (кто звонит, кто в групповом звонке, ссылки) хранится в **БД** в перечисленных таблицах.
- Отдельного «сохранённого места» под пользовательские настройки звонков (типа «всегда только аудио») в коде нет; при необходимости их нужно добавлять (например, отдельная таблица или поле в `users`/профиле).

Чтобы проверить, что именно сохраняется на сервере по звонкам, достаточно просмотреть `config/config.php` и выполнить приведённые SQL-запросы к вашей БД.
