# Восстановление прав доступа после загрузки файлов на сервер

После загрузки (git pull, rsync, FTP и т.п.) владельцем файлов может оказаться не пользователь веб-сервера, из‑за чего сайт перестаёт открываться или не работают загрузки, конфиг, миграции.

## Быстрое восстановление (рекомендуется)

Выполните из **корня проекта** (каталог `messenger`):

```bash
cd /путь/к/messenger
sudo sh tools/fix-permissions.sh
```

По умолчанию скрипт ставит владельца **http** и группу **users** (подходит для Synology). Если на сервере веб-сервер запускается от другого пользователя, укажите его первым аргументом:

```bash
sudo sh tools/fix-permissions.sh www-data
# или
sudo sh tools/fix-permissions.sh apache
sudo sh tools/fix-permissions.sh nginx
```

Второй аргумент — группа (по умолчанию `users`):

```bash
sudo sh tools/fix-permissions.sh http users
```

## Что делает скрипт

- Назначает владельцем пользователя веб-сервера: корневые PHP-файлы, `.htaccess`, `composer.json` и т.д.
- Рекурсивно меняет владельца каталогов: `admin`, `api`, `assets`, `auth`, `config`, `includes`, `sql`, `docs`, `tools`, `uploads`, `vendor`, `websocket`.
- Ставит права: каталоги **755**, файлы **644**.
- В `uploads/` и `logs/` добавляет право записи для владельца (загрузка файлов, логи).

## Ручное восстановление

Если скрипт запустить нельзя, выполните вручную (подставьте вместо `http` пользователя вашего веб-сервера):

```bash
cd /путь/к/messenger

# Владелец всего проекта — пользователь веб-сервера
sudo chown -R http:users .

# Каталоги: чтение и вход (755)
find . -type d -exec chmod 755 {} \;

# Файлы: чтение (644)
find . -type f -exec chmod 644 {} \;

# Запись в uploads и logs
sudo chmod -R u+rwX uploads
[ -d logs ] && sudo chmod -R u+rwX logs

# Исполняемые скрипты (если нужны)
chmod +x tools/*.sh 2>/dev/null || true
```

## Как узнать пользователя веб-сервера

- **Synology** — обычно `http`.
- **Apache (Debian/Ubuntu)** — часто `www-data`.
- **Nginx** — часто `nginx` или `www-data`.

Проверка (Linux): `ps aux | grep -E 'apache|nginx|httpd'` — в первом столбце будет пользователь.

## Ответ 400 с HTML-страницей Synology вместо JSON

Если при POST к `api/reactions.php` в ответ приходит **HTML-страница Synology** (круг с «400», «Copyright (c) 2021 Synology Inc.»), запрос **не доходит до PHP** — его перехватывает прокси/веб-сервер Synology и возвращается штатная страница ошибки.

**Обход:** приложение отправляет реакции в формате **form-urlencoded** (`application/x-www-form-urlencoded`) вместо JSON, чтобы обойти возможную блокировку POST с телом JSON или Unicode. Сервер принимает оба формата.

Если 400 сохраняется и с form-urlencoded, нужно в DSM / Web Station проверить: ограничения размера тела запроса, правила reverse proxy, ModSecurity/WAF и доступ к ` /sites/messenger/api/*`.

## Ошибка 403 (Forbidden) на API

Если в браузере при работе с мессенджером в консоли появляются ошибки **403 Forbidden** на запросы к `api/reactions.php` или другим скриптам в `api/`, чаще всего веб-сервер не может прочитать или выполнить эти файлы из‑за прав доступа.

**Что сделать:**

1. Запустите восстановление прав из корня проекта:
   ```bash
   cd /путь/к/messenger
   sudo sh tools/fix-permissions.sh
   ```
2. Убедитесь, что владелец каталога `api/` и файлов в нём — пользователь веб-сервера (на Synology обычно `http`):
   ```bash
   ls -la api/
   ```
   Должны быть права **644** на файлы и владелец, под которым работает веб-сервер.
3. Если 403 остаётся — проверьте логи веб-сервера (Apache/Nginx или Synology Web Station), там может быть точная причина (например, правило ModSecurity или доступ по IP).

После исправления прав обновите страницу мессенджера; запросы к API должны проходить без 403.

## После восстановления

Откройте сайт в браузере и проверьте:

- вход в мессенджер;
- отправку сообщений;
- загрузку аватара или файла (если есть);
- реакции на сообщения (пикер эмодзи) и прочие вызовы API;
- при необходимости снова откройте миграцию: `.../tools/run_e2ee_migration.php` (под админом).
